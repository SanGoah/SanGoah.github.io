(()=>{"use strict";const e=window.crypto||window.msCrypto,t=window.localStorage,n=y("hexo-blog-encrypt的作者们都是大帅比!"),r=y("hexo-blog-encrypt是地表最强Hexo加密插件!"),o=document.getElementById("hexo-blog-encrypt"),a=o.dataset.wpm,c=o.dataset.whm,i=o.getElementsByTagName("script").hbeData,l=i.innerText,s=i.dataset.hmacdigest;function d(e){return new Uint8Array(e.match(/[\da-f]{2}/gi).map(e=>parseInt(e,16)))}function y(e){for(var t=e.length,n=0,r=new Array,o=0;o<t;){var a=e.codePointAt(o);a<128?(r[n++]=a,o++):a>127&&a<2048?(r[n++]=a>>6|192,r[n++]=63&a|128,o++):a>2047&&a<65536?(r[n++]=a>>12|224,r[n++]=a>>6&63|128,r[n++]=63&a|128,o++):(r[n++]=a>>18|240,r[n++]=a>>12&63|128,r[n++]=a>>6&63|128,r[n++]=63&a|128,o+=2)}return new Uint8Array(r)}function u(e){if("object"!=typeof e||null===e||"number"!=typeof e.byteLength)throw new TypeError("Expected input to be an ArrayBuffer");for(var t,n=new Uint8Array(e),r="",o=0;o<n.length;o++)r+=1===(t=n[o].toString(16)).length?"0"+t:t;return r}async function h(e){let t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll("script").forEach(async e=>{e.replaceWith(await async function(e){let t=document.createElement("script");return["type","text","src","crossorigin","defer","referrerpolicy"].forEach(n=>{e[n]&&(t[n]=e[n])}),t}(e))}),t}async function m(t,n,r){let o=d(l);return await e.subtle.decrypt({name:"AES-CBC",iv:n},t,o.buffer).then(async t=>{const n=(new TextDecoder).decode(t),o=document.createElement("button");o.textContent="Encrypt again",o.type="button",o.classList.add("hbe-button"),o.addEventListener("click",()=>{window.localStorage.removeItem("hexo-blog-encrypt"),window.location.reload()}),document.getElementById("hexo-blog-encrypt").style.display="inline",document.getElementById("hexo-blog-encrypt").innerHTML="",document.getElementById("hexo-blog-encrypt").appendChild(await h(n)),document.getElementById("hexo-blog-encrypt").appendChild(o),document.querySelectorAll("img").forEach(e=>{e.getAttribute("data-src")&&!e.src&&(e.src=e.getAttribute("data-src"))});var a=document.getElementById("toc-div");a&&(a.style.display="inline");var i=document.getElementsByClassName("toc-div-class");if(i&&i.length>0)for(var l=0;l<i.length;l++)i[l].style.display="inline";return await async function(t,n){const r=(new TextEncoder).encode(n);let o=d(s);const a=await e.subtle.verify({name:"HMAC",hash:"SHA-256"},t,o,r);return console.log(`Verification result: ${a}`),a||(alert(c),console.log(`${c}, got `,o," but proved wrong.")),a}(r,n)}).catch(e=>(alert(a),console.log(e),!1))}!function(){const a=JSON.parse(t.getItem("hexo-blog-encrypt"));if(a){console.log("Password got from localStorage(hexo-blog-encrypt): ",a);const n=d(a.iv).buffer,r=a.dk,o=a.hmk;e.subtle.importKey("jwk",r,{name:"AES-CBC",length:256},!0,["decrypt"]).then(r=>{e.subtle.importKey("jwk",o,{name:"HMAC",hash:"SHA-256",length:256},!0,["verify"]).then(e=>{m(r,n,e).then(e=>{e||t.removeItem("hexo-blog-encrypt")})})})}o.addEventListener("keydown",async o=>{if(o.isComposing||13===o.keyCode){const o=document.getElementById("hbePass").value,a=await function(t){let n=new TextEncoder;return e.subtle.importKey("raw",n.encode(t),{name:"PBKDF2"},!1,["deriveKey","deriveBits"])}(o),c=await function(t){return e.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:n.buffer,iterations:1024},t,{name:"HMAC",hash:"SHA-256",length:256},!0,["verify"])}(a),i=await function(t){return e.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:n.buffer,iterations:1024},t,{name:"AES-CBC",length:256},!0,["decrypt"])}(a),l=await function(t){return e.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:r.buffer,iterations:512},t,128)}(a);m(i,l,c).then(n=>{console.log(`Decrypt result: ${n}`),n&&e.subtle.exportKey("jwk",i).then(n=>{e.subtle.exportKey("jwk",c).then(e=>{const r={dk:n,iv:u(l),hmk:e};t.setItem("hexo-blog-encrypt",JSON.stringify(r))})})})}})}()})();